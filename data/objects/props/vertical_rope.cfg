[object_type]
id=vertical_rope

	[vars]
	max_length=300
	length=150
	start_pos=0
	segments="[]"
	[/vars]

	[properties]
	set_pos_len="def(pos, len) [set(vars.length, len), set(vars.start_pos, pos%5), fire_event(me, 'calculate_segments')]"
	move_pos="def(amount) [set(vars.start_pos, (vars.start_pos+amount)%5), fire_event(me, 'calculate_segments')]"
	top="get_object(level, vars.top_segment)"
	bot="get_object(level, vars.bot_segment)"
	set_y="def(new_y) if(new_y != y, [set(y, y + diff),
	                   if(vars.top_segment, set(top.y, top.y + diff)),
	                   if(vars.bot_segment, set(bot.y, bot.y + diff)),
					  ] +
					  map(vars.segments, 'seg', set(get_object(level, seg).y, get_object(level, seg).y + diff)))
	   where diff = new_y - y"
	[/properties]

	on_spawned="[map(range(vars.max_length/5 - size(vars.segments)), spawn('vertical_rope_segment', midpoint_x, midpoint_y, 1)), fire_event('calculate_segments')]"

	on_child_spawned="if((not vars.top_segment),
	        set(vars.top_segment, child.label),
	    if((not vars.bot_segment), set(vars.bot_segment, child.label),
		    set(vars.segments, vars.segments + [child.label])))"

	on_calculate_segments="
	 def clear_segment(seg) set(seg.alpha, 0);
	 def set_segment(obj, seg, n) [set(seg.alpha, 255),
	                               set(seg.y, obj.y + (5 - obj.start_pos) + 5*n)];
	 if(vars.length > vars.max_length - 10,
		#if we don't have enough child objects to handle a rope this long,
		 then double our maximum length and respawn the object#
	   [set(vars.max_length, vars.max_length*2 + 10), fire_event('spawned')],

	 [set(top_seg.animation, if(start_pos = 0, 'normal', 'bottom' + (5 - start_pos))), set(top_seg.y, y)] +
	 [set(bot_seg.y, y + vars.length - tail_len), if(tail_len = 0, set(bot_seg.alpha, 0), [set(bot_seg.alpha, 255), set(bot_seg.animation, 'top' + tail_len)])] +
	 map(vars.segments, 'seg', clear_segment(get_object(level, seg))) +
	 map(range(num_main_segments), 'n', set_segment(me, get_object(level, vars.segments[n]), n))
	 )
	  where
	   top_seg = get_object(level, vars.top_segment),
	   bot_seg = get_object(level, vars.bot_segment),
	   start_main_ypos = y + (5 - start_pos),
	   tail_len = (length - (5 - start_pos))%5,
	   num_main_segments = (length - (5 - start_pos))/5
	"

	[base:animation]
	image=props/rope.png
	x=0
	w=4
	[/animation]

	[animation]
	id=normal
	y=0
	h=1
	[/animation]

[/object_type]

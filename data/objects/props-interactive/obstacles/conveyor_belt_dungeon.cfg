{
id: "conveyor_belt_dungeon",
editor_info: {
	category: "platforms",
	var: [
		{
			name: "x_1",
			type: "x",
			value: "x",
		},
		{
			name: "y_1",
			type: "y",
			value: "y",
		},
		{
			name: "x_2",
			type: "x",
			value: "x+200",
		},
		{
			name: "y_2",
			type: "y",
			value: "y",
		},
		{
			name: "right_edge",
			type: "x",
			value: "x+200",
		},
		{
			name: "speed",
			value: 2,
		},
	],
},
zorder:-5,
hidden_in_game: true,


properties: {
	length: "length(x_1,y_1,x_2,y_2)",
	wheel_radius: "27/2",
},



on_start_level: "[fire_event('setup')]",
on_setup: "[
					spawn('rope_angled_controller',x,y,facing,[set(animation,'dungeon-conveyor-belt-top'),set(vars.top, child),set(z,z-2)]),
					spawn('rope_angled_controller',x,y,facing,[set(animation,'dungeon-conveyor-belt-bottom'),set(vars.bottom, child),set(z,z-3)]),
					spawn('rope_angled_controller',x,y,facing,[set(animation,'dungeon-conveyor-belt-supports'),set(vars.supports, child),set(z,z-2)]),
					
					spawn(me.type+'.belt',x_1,y_1,facing,[set(vars.tttop, child),set(z,z-1)]),

					spawn(me.type+'.wheel',x_1,y_1,facing,[set(vars.wheel_left, child),set(z,z-1)]),
					spawn(me.type+'.wheel',x_2,y_2,facing,[set(vars.wheel_right, child),set(z,z-1)]),
					fire_event('on_calculate_segments')]",
					
			

on_calculate_segments: "[	set(xy,[x_1-wheel_radius*1.5, y_1-wheel_radius*2.5]),
							set(platform_area, [0,0,abs(x_2-x_1)/2 + 1.5*wheel_radius,1]),
							set(platform_motion_x, vars.speed*67),
							set(progress,vars.speed),

							top.set_offset(progress),
							top.set_ends(x_1,y_1-wheel_radius*2.5,x_2,y_2-wheel_radius*2.5),

							tttop.set_offset(progress),
							tttop.set_ends(x_1,y_1-wheel_radius*2.5,x_2,y_2-wheel_radius*2.5),


							supports.set_ends(x_1,y_1-wheel_radius*2.5 +24,x_2,y_2-wheel_radius*2.5+24),

							bottom.set_offset(progress),
							bottom.set_ends(x_2,y_2+wheel_radius,x_1,y_1+wheel_radius),
							
							set(wheel_left.rotate, (wheel_left.rotate + progress)%360),
							set(wheel_right.rotate, (wheel_right.rotate + progress)%360),
							set(platform_offsets, [0,y_2-y_1]),
							]",

on_process: "fire_event('calculate_segments')",

platform_area: [0,0,200,1],
animation: {
	id: "normal",
	image: "effects/particles.png",
	x: 86,
	y: 73,
	w: 28,
	h: 28,
	collide: [0,0,28,28],
	frames: 1,
	duration: 1000,
},
object_type: [
	{
		id: "wheel",
		animation: {
			id: "normal",
			image: "props/dungeon-conveyor-belt-wheel.png",
			x: 0,
			y: 0,
			w: 27,
			h: 27,
		},
	},
	{
		id: "belt",
		properties: {
			length: "length(x_1,y_1,x_2,y_2)",
			set_ends: "def(new_x1,new_y1,new_x2,new_y2) [set(vars.x_1,new_x1),set(vars.y_1,new_y1),set(vars.x_2,new_x2),set(vars.y_2,new_y2),fire_event(me,'create'),]",
			set_offset: "def(pixels) execute(me, [set(draw_area, [0, pixels, img_w/2, length/2]), set(offset_counter,(offset_counter+pixels)%img_w)])",
		},
		on_create: "[
			set(x, x_1),
			set(y, y_1),
			set(draw_area, [offset_counter, 0, length/2, img_h/2]),
			set(activation_area, [min(x_1,x_2) -200, min(y_1,y_2) -200, abs(x_1-x_2) +200, abs(y_1-y_2) +200]),  #xywh#
			set(custom_draw, [0.0,1.0,2.0,3.0, [0,0], [length,(y_2-y_1)], [length,(y_2-y_1)+16], [0,0+16]]) 
			]",
		
		animation: {
			id: "normal",
			image: "props/dungeon-conveyor-belt-tttop.png",
			x: 0,
			y: 0,
			w: 16,
			h: 16,
		},
	},

],
}

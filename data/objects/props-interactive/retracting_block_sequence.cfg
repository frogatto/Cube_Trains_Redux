[object_type]
id=retracting_block_sequence
always_active=yes

	[vars]
	blocks="[]"
	sequence="[20, -10]"
	xpos=0
	ypos=0
	platform_length=10
	position=0
	activated=0
	[/vars]

	[properties]
	add_block="def (xmove, ymove) execute(me,
	             [spawn('retracting_block_sequence.block',
				        vars.xpos + xmove, vars.ypos + ymove, facing),
				  add(vars.xpos, xmove),
				  add(vars.ypos, ymove)
				 ])"
	[/properties]

	on_create="[set(alpha, 0), set(vars.xpos, midpoint_x), set(vars.ypos, midpoint_y),
	 fire_event('add_block'),
	 map(vars.sequence, 'b', if(index%2,
	           if(b < 0, map(range(abs(b)), fire_event('add_block_up')),
					     map(range(abs(b)), fire_event('add_block_down'))),
	           if(b < 0, map(range(abs(b)), fire_event('add_block_left')),
					     map(range(abs(b)), fire_event('add_block_right'))))),
	 fire_event('reset')

	]"

	timer_frequency=10

	on_timer="if(vars.activated, [if(vars.position + vars.platform_length < vars.blocks.size-1,
	              add(vars.position, 1)), 
			   set(vars.blocks[vars.position].animation, 'retracting'),
			   set(vars.blocks[vars.position+vars.platform_length].animation, 'extending')])"

	on_reset="[map(vars.blocks, 'b', set(b.animation, if(index < vars.platform_length, 'extended', 'retracted'))), set(vars.position, 0)]"

	on_child_spawned="add(vars.blocks, [child])"
	on_add_block="add_block(0, 0)"
	on_add_block_up="add_block(0, -32)"
	on_add_block_down="add_block(0, 32)"
	on_add_block_left="add_block(-32, 0)"
	on_add_block_right="add_block(32, 0)"
		[animation]
		id=normal
		image=props/retracting-blocks.png
		rect=0,0,15,31
		frames=1
		duration=200
		[/animation]
		
	on_end_retracting_anim="animation('retracted')"
	on_end_extending_anim="animation('extended')"

	[object_type]
	id=block
	has_feet=no
	on_change_animation_failure="[animation(previous_animation), schedule(4, animation('extended'))]"
	zorder=-2

	solid_dimensions=player,common
	solid_area=8,31,7,31
		[animation]
		id=retracted
		image=props/retracting-blocks.png
		rect=64,0,79,31
		frames=1
		duration=100000
		[/animation]

		[animation]
		id=retracting
		image=props/retracting-blocks.png
		rect=0,0,15,31
		frames=4
		duration=5
		solid_area=0,15,15,30
		[/animation]

		[animation]
		id=extending
		image=props/retracting-blocks.png
		rect=0,0,15,31
		frames=4
		duration=5
		play_backwards=yes
		solid_area=0,15,15,30
		[/animation]

		[animation]
		id=extended
		image=props/retracting-blocks.png
		rect=0,0,15,31
		frames=1
		duration=100000
		solid_area=0,15,15,30
		[/animation]

	[/object_type]
[/object_type]

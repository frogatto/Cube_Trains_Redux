#let ancestral know
[object_type]
	id=civ_board
	hitpoints=2
	zorder=-10
	no_compile_image="experimental/civ-tile.png"
	
	[editor_info]
		category=crazy-stuff
	[/editor_info]
	
	[properties]
		mouse = "def() level.player.ctrl_mice[0]"
		
		board_size = "def() consts.tile_size*consts.tiles"
		
		tile_at = "def (coord) [x+consts.tile_size+x_in*consts.tile_size*2,y+consts.tile_size+y_in*consts.tile_size*2] where x_in = coord[0] where y_in = coord[1]"
		
		on_tile = "def() 
			if(mx > x and mx < x+board_size()*2 and my > y and my < y+board_size()*2 and (not [tx, ty] in map(vars.play, 'vp', vp.vars.gridloc)),
				[tx, ty])
			where tx = (mx-x)/(consts.tile_size*2)
			where ty = (my-y)/(consts.tile_size*2)
			where mx = level.player.vars.mouse.pos_x() where my = level.player.vars.mouse.pos_y()"
			
		dealt_hand_loc = "def (player, spot) if(spot in range(consts.hand_size) and player = 0,
		[x - consts.tile_size + margin + step * spot, y + board_size()*2 + space_beneath]
		where step = ((board_size() - margin) * 2) / (consts.hand_size - 1)
		where margin = 125
		where space_beneath = 20
		)"
		
		#needs work#
		open_hand = "def (player) if(vars.hand and player = 0, frees where frees = map(range(size(vars.hand)), 'slot', 'Slot ' + str(slot) + ': ' + vars.hand[slot].type), -1)"
	[/properties]
	
	[consts]
		tiles = 14
		tile_size = 16
		hand_size = 6
	[/consts]
	
	[vars]
		hand = []
		play = []
	[/vars]
	
	on_create="[set(draw_area, [0, 0, board_size(), board_size()]),
		
		#
		[set(hand, new_tiles),
		map(new_tiles, 'new_tile', add_object(new_tile)),
		] where new_tiles = map(range(consts.hand_size), 'deal', 
			object('civ-tile_blank', crd[0], crd[1], facing)
			where crd = dealt_hand_loc(0, deal)),
		#
		
		[set(new_bag.vars.spawner, self),
		add_object(new_bag),
		set(vars.bag, new_bag),
		]where new_bag = object('civ-tile_bag', x + board_size()*2 + 100, y+((board_size()*5)/3), facing),
		
		
		]"
		
	on_lmb_down="map(vars.hand, 'tile', fire_event(tile, 'lmb_down', level.player.vars.mouse))"
		
	on_lmb_hold="[
		#debug('tile:', on_tile())#
		if(ot,
			[set(tmp.old_ot, ot),
			if(tmp.old_ot != ot,
				[set(tmp.tile_highlight, hlt),
				add_object(hlt),
				remove_object(tmp.tile_highlight),
				]where hlt = object('civ_board.tile', tile_at(ot)[0], tile_at(ot)[1], facing)
				)
			],
			[set(tmp.old_ot, 0),
			remove_object(tmp.tile_highlight),
			])
		where ot = on_tile()
		]"
		
	on_lmb_up="remove_object(tmp.tile_highlight)"
		
	on_release_tile="
		if(on_tile(), 
			[set(arg.midpoint_x, tile_at(on_tile())[0]), 
			set(arg.midpoint_y, tile_at(on_tile())[1]), 
			set(vars.play, vars.play + [arg]), 
			set(arg.vars.gridloc, on_tile()),
			set(vars.bag.vars.on_deal_tile, arg.vars.hand_pos),
			fire_event(vars.bag, 'deal_p1'),
			if(size(vars.bag.vars.pile) = 1, debug('Game Over')),
			],
			arg.go_to(dealt_hand_loc(0,arg.vars.hand_pos)))"
	
	on_rmb_down="map(vars.play, 'vp', debug(vp.vars.gridloc))"
	
	on_end_anim="animation('normal')"
	
	[animation]
		id=normal
		image=experimental/civ-tile.png
		x=0
		y=0
		w=16
		h=16
		pad=-1
		frames=1
		duration=6541
		surface_area=all
	[/animation]
	
	
	[object_type]
		id=tile
		hitpoints=2
		zorder=-9
		
		on_create = "[
			set(red, tint), set(green, tint), set(blue, tint),
			] where tint = 200"
		
		[animation]
			id=normal
			image=experimental/civ-tile.png
			x=0
			y=0
			w=16
			h=16
			pad=-1
			frames=1
			duration=6541
			surface_area=all
		[/animation]
	[/object_type]
	
[/object_type]
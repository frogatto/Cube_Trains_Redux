#let ancestral know
[object_type]
	id=civ_board
	hitpoints=2
	zorder=-11
	no_compile_image="experimental/civ-tile.png"
	
	[editor_info]
		category=crazy-stuff
	[/editor_info]
	
	[properties]
		mouse = "def() level.player.ctrl_mice[0]"
		
		board_size = "def() consts.tile_size*consts.tiles"
		
		#returns the pixels of the coordinates passed in.#
		tile_at = "def (coord) [x+consts.tile_size+x_in*consts.tile_size*2,y+consts.tile_size+y_in*consts.tile_size*2] where x_in = coord[0] where y_in = coord[1]"
		
		#Returns the tile the mouse is on.#
		on_tile = "def() 
			if(mx > x and mx < x+board_size()*2 and my > y and my < y+board_size()*2 and (not [tx, ty] in map(vars.play, 'vp', vp.vars.gridloc)),
				[tx, ty])
			where tx = (mx-x)/(consts.tile_size*2)
			where ty = (my-y)/(consts.tile_size*2)
			where mx = level.player.vars.mouse.pos_x() where my = level.player.vars.mouse.pos_y()"
		
		#Takes player (0) and a spot in the hand to deal to.#
		dealt_hand_loc = "def(player, spot) if(spot in range(consts.hand_size) and player = 0,
		[x - consts.tile_size + margin + step * spot, y + board_size()*2 + space_beneath]
		where step = ((board_size() - margin) * 2) / (consts.hand_size - 1)
		where margin = 125
		where space_beneath = 20
		)"
		
		#Takes x,y board coordinate, returns terrain name there.#
		get_terrain = "def(coords) switch(consts.land[coords[0] + coords[1]*consts.tiles], 0, 'ocean_grid', 1, 'plains_grid', 2, 'hill_grid', 3, 'ore_grid', 'ocean_grid')"
		
		has_food = "def(coords) if(1 in map([[-1,0],[0,-1],[1,0],[0,1]], 'offset', if(get_terrain([coords[0]+offset[0],coords[1]+offset[1]]) = 'plains_grid', 1, 0)) and 1 #add something to check for kingdom food#, 1, 0)"
		
		is_valid_addition = "def(obj, coords) 
			switch(obj.type,
			'civ-tile_farm',	if(get_terrain(coords) = 'plains_grid', 1, 0),
			'civ-tile_mine',	if(get_terrain(coords) in ['hill_grid', 'ore_grid'] and has_food(coords), 1, 0),
			'civ-tile_settle',	if(get_terrain(coords) != 'ocean_grid' and has_food(coords), 1, 0),
			'civ-tile_war',		if(get_terrain(coords) != 'ocean_grid' and has_food(coords), 1, 0),
			0)"
		
		
	[/properties]
	
	[consts]
		tiles = 14		# number of tiles on board #
		tile_size = 16	# size of tile image #
		hand_size = 6	# number of tiles in hand #
		land = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,3,0,1,1,0,0,0,0,0,0,0,0,0,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,2,2,0,0,0,0,0,1,1,0,0,0,0,0,0,2,0,0,0,0,0,0,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0,0,1,1,1,1,2,2,2,1,1,0,0,0,0,0,1,1,1,2,3,2,2,1,1,1,0,0,0,0,0,1,2,2,2,2,2,0,0,0,0,0,0,1,1,1,1,2,2,3,2,2,0,0,0,0,0,0,1,1,0,0,2,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,]
	[/consts]
	
	[vars]
		hand = []	#tiles in hand#
		play = []	#tiles in play#
	[/vars]
	on_create="[set(draw_area, [0, 0, board_size(), board_size()]),
		
		#
		[set(hand, new_tiles),
		map(new_tiles, 'new_tile', add_object(new_tile)),
		] where new_tiles = map(range(consts.hand_size), 'deal', 
			object('civ-tile_blank', crd[0], crd[1], facing)
			where crd = dealt_hand_loc(0, deal)),
		#
		
		[set(new_bag.vars.spawner, self),
		add_object(new_bag),
		set(vars.bag, new_bag),
		]where new_bag = object('civ-tile_bag', x + board_size()*2 + 100, y+((board_size()*5)/3), facing),
		
		if(size(consts.land) = consts.tiles*consts.tiles,
			map(range(size(consts.land)), 'land_index', spawn(self.type + '.' + ltype, lcoord[0], lcoord[1], facing) where lcoord = tile_at([land_index%consts.tiles, land_index/consts.tiles]) where ltype = switch(consts.land[land_index], 0, 'ocean_grid', 1, 'plain_grid', 2, 'hill_grid', 3, 'ore_grid', 'ocean_grid')),
			debug(size(consts.land), 'does not equal', consts.tiles*consts.tiles)),
		
		]"
		
	on_lmb_down="map(vars.hand, 'tile', fire_event(tile, 'lmb_down', level.player.vars.mouse))"
		
	on_lmb_hold="[
		#debug('tile:', on_tile())#
		if(ot,
			[set(tmp.old_ot, ot),
			if(tmp.old_ot != ot,
				[set(tmp.tile_highlight, hlt),
				add_object(hlt),
				remove_object(tmp.tile_highlight),
				]where hlt = object('civ_board.tile', tile_at(ot)[0], tile_at(ot)[1], facing)
				)
			],
			[set(tmp.old_ot, 0),
			remove_object(tmp.tile_highlight),
			])
		where ot = on_tile()
		]"
		
	on_lmb_up="remove_object(tmp.tile_highlight)"
		
	on_release_tile="[
		if(on_tile() and is_valid_addition(arg, on_tile()), 
			[set(arg.midpoint_x, tile_at(on_tile())[0]), 
			set(arg.midpoint_y, tile_at(on_tile())[1]), 
			set(vars.play, vars.play + [arg]), 
			set(arg.vars.gridloc, on_tile()),
			set(vars.bag.vars.on_deal_tile, arg.vars.hand_pos),
			fire_event(vars.bag, 'deal_p1'),
			if(size(vars.bag.vars.pile) = 1, debug('Game Over')),
			],
			arg.go_to(dealt_hand_loc(0,arg.vars.hand_pos))),
			
		is_valid_addition(arg, on_tile())
		]"
	
	on_rmb_down="if(on_tile(), debug(get_terrain(on_tile())))"
	
	on_end_anim="animation('normal')"
	
	[animation]
		id=normal
		image=experimental/civ-tile.png
		x=0
		y=0
		w=16
		h=16
		pad=-1
		frames=1
		duration=6541
		surface_area=all
	[/animation]
	
	
	[object_type]
		id=tile
		hitpoints=2
		zorder=-9
		
		on_create = "[
			#set(red, tint), set(green, tint), set(blue, tint),#
			set(alpha, tint),
			] where tint = 75"
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=11
			y=10
			w=16
			h=16
			pad=-1
			frames=1
			duration=541
			surface_area=all
		[/animation]
	[/object_type]
	
	[object_type]
		id=ocean_grid
		hitpoints=2
		zorder=-10
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=14
			y=85
			w=16
			h=16
			pad=-1
			frames=1
			duration=542
			surface_area=all
		[/animation]
	[/object_type]
	
	[object_type]
		id=plain_grid
		hitpoints=2
		zorder=-10
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=14
			y=108
			w=16
			h=16
			pad=-1
			frames=1
			duration=543
			surface_area=all
		[/animation]
	[/object_type]
	
	[object_type]
		id=hill_grid
		hitpoints=2
		zorder=-10
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=14
			y=153
			w=16
			h=16
			pad=-1
			frames=1
			duration=544
			surface_area=all
		[/animation]
	[/object_type]
	
	[object_type]
		id=ore_grid
		hitpoints=2
		zorder=-10
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=33
			y=153
			w=16
			h=16
			pad=-1
			frames=1
			duration=999999999
			surface_area=all
		[/animation]
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=52
			y=153
			w=16
			h=16
			pad=-1
			frames=1
			duration=999999999
			surface_area=all
		[/animation]
		
		[animation]
			id=normal
			image=experimental/civ-stuff.png
			x=71
			y=153
			w=16
			h=16
			pad=-1
			frames=1
			duration=999999999
			surface_area=all
		[/animation]
	[/object_type]
	
[/object_type]
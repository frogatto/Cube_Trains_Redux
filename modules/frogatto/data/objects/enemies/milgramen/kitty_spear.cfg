{
id: "kitty_spear",
prototype: ["kitty"],
solid_area: [6,10,26,33],
properties: {
	choose_action: "def() if(player_noticeable, alert(), animation('walk'))",

	player_noticeable: "if(player_in_decent_y_pos and abs(level.player.midpoint_x - self.midpoint_x) < if(self.facing = desired_facing, front_detection_area, rear_detection_area), 1, 0)",
	player_in_target_area:  "if(player_noticeable and self.facing = desired_facing, 1, 0)",
	rear_detection_area: "if(higher_difficulty, 1200, 200)",
	front_detection_area: "if(higher_difficulty, 1200, 400)",
	player_in_decent_y_pos: "(level.player.midpoint_y > self.y and level.player.midpoint_y < self.y2)",
	in_stabbing_range: "(abs(level.player.midpoint_x - self.midpoint_x) < 90)",
	
	attack_countdown_length: "if(higher_difficulty, 0, 3)",

	prepare_to_strike: "def() [animation('readyspearthrust'),set(vars.attack_counter,0)]",
	prepare_to_dash: "def() if(facing != desired_facing, [animation('turn'), set(facing, desired_facing)], animation('dash'))",
	alert: "def() if(higher_difficulty and should_skip_alert, prepare_to_dash(), [animation('alert'),set(vars.last_alert,level.cycle)]) where should_skip_alert = (abs(level.cycle - vars.last_alert) < 300)",

	attack_damage: "if(level.player.difficulty <= level.player.difficulty_casual,1,2)",
	higher_difficulty: "level.player.difficulty > level.player.difficulty_casual",
},
vars: {
	points_value: 271,
	turns_at_cliffs: 1,
	turns_towards_player: 0,
	posthurt_counter: 0,
	attack_counter: 0,
	last_alert: -300,
},
consts: {
	basic_type: "kitty_spear",
	frogourmet_tag: "kitty_spear",
},
on_end_alert_anim: "prepare_to_dash()",
on_end_stand_anim: "choose_action()",
on_end_walk_anim: "choose_action()",
on_end_turn_anim: "if(in_stabbing_range and
	                     player_in_decent_y_pos,
	                     prepare_to_strike(), if(higher_difficulty, choose_action(), animation('stand') ) )",
on_collide_side: "if(animation in ['readyspearthrust', 'spearthrust'], [set(velocity_x, 0)], proto_event('kitty', 'collide_side'))",
on_end_dash_anim: "if(in_stabbing_range or facing != desired_facing, prepare_to_strike(), animation('dash'))",
on_process_dash: "[if(in_stabbing_range, prepare_to_strike()), set(accel_x,if(higher_difficulty, 1500, 1000) )]",
##TODO add (limited!) jumping over chasms on harder difficulties?

on_end_readyspearthrust_anim: "if(vars.attack_counter < attack_countdown_length, [add(vars.attack_counter, 1),animation('readyspearthrust')], [animation('spearthrust'), sound('weapon-swing-light'+1d4+'.wav'), set(velocity_x, 400*facing)])",
on_end_spearthrust_anim: "if(facing != desired_facing,
	                          [animation('turn'), set(facing, desired_facing)],
	                           if(in_stabbing_range and higher_difficulty, prepare_to_strike(), animation('stand')))",
on_end_hurt_anim: "if(is_standing,[set(vars.posthurt_counter, 3),animation('posthurt')],animation('hurt'))",
on_end_posthurt_anim: "if(vars.posthurt_counter > 0,[set(vars.posthurt_counter, vars.posthurt_counter - 1),animation('posthurt')],animation('stand'))",

on_footfall: "[sound('kitty-footstep'+1d10+'.wav', volume)] where volume = constrain(0, 300.0/distance(self, level.player),1.0)",

on_create: "[proto_event('kitty','create'), if(higher_difficulty,set(activation_border,800))]",

animation: [
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "stand",
		rect: [1,1,41,36],
		frames: 7,
		duration: 8,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "turn",
		rect: [1,118,41,153],
		frames: 1,
		duration: 12,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 300,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "walk",
		rect: [1,79,41,114],
		frames: 4,
		duration: 6,
		events: "0:12:footfall",
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 1000,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "dash",
		rect: [177,79,217,114],
		frames: 4,
		duration: 6,
		events: "0:6:12:18:footfall",
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "readyspearthrust",

		#charges up a visible impending spear attack.  Repeat 3x.
		rect: [45,118,90,153],
		frames: 2,
		duration: 2,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "spearthrust",

		#the actual thrust itself.  Give him a burst of velocity at the start.
		rect: [143,118,188,153],
		frames: 5,
		duration: 6,
		attack_area: [30,23,38,32],
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "spring",
		rect: [1,40,41,75],
		frames: 5,
		duration: 4,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "hurt",
		rect: [1,157,41,192],
		frames: 1,
		duration: 12,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "posthurt",

		#looks around angrily to see who hit him.  Repeat 3x.
		rect: [133,157,173,192],
		frames: 2,
		duration: 4,
	},
	{
		image: "enemies/kitty-spear.png",
		accel_x: 0,
		accel_y: 80,
		pad: 3,
		rotate_on_slope: true,
		body_area: "all",
		id: "alert",

		#"Hey, I see the player!"  hops with an ! over head and gets mad.
		rect: [1,197,41,232],
		frames: 6,
		duration: 6,
	},
],
}
